<!DOCTYPE html>
<html lang="id" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - MobilityGraph</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/static/favicon.png">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc',
                            400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1',
                            800: '#075985', 900: '#0c4a6e',
                        },
                        mrt: '#e63946', lrt: '#f4a261', tj: '#2a9d8f',
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'], }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .mode-mrt {
            background: linear-gradient(135deg, #e63946, #c81e30);
        }

        .mode-lrt {
            background: linear-gradient(135deg, #f4a261, #e87f17);
        }

        .mode-tj {
            background: linear-gradient(135deg, #2a9d8f, #1e7268);
        }

        /* Theme Toggle Animations */
        #theme-toggle {
            position: relative;
            overflow: hidden;
        }

        #theme-toggle::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #theme-toggle:hover::before {
            opacity: 1;
        }

        #theme-toggle:active {
            transform: scale(0.9);
        }

        #theme-toggle svg {
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        #theme-toggle:hover svg {
            transform: rotate(15deg) scale(1.1);
        }

        .dark #theme-toggle svg.text-amber-300 {
            animation: sunRise 0.6s ease-out;
        }

        html:not(.dark) #theme-toggle svg:not(.text-amber-300) {
            animation: moonRise 0.6s ease-out;
        }

        @keyframes sunRise {
            0% {
                transform: rotate(-90deg) scale(0);
                opacity: 0;
            }

            50% {
                transform: rotate(20deg) scale(1.2);
            }

            100% {
                transform: rotate(0deg) scale(1);
                opacity: 1;
            }
        }

        @keyframes moonRise {
            0% {
                transform: rotate(90deg) scale(0);
                opacity: 0;
            }

            50% {
                transform: rotate(-20deg) scale(1.2);
            }

            100% {
                transform: rotate(0deg) scale(1);
                opacity: 1;
            }
        }

        html.theme-transition,
        html.theme-transition *,
        html.theme-transition *::before,
        html.theme-transition *::after {
            transition: background-color 0.5s ease,
                background 0.5s ease,
                color 0.4s ease,
                border-color 0.4s ease,
                box-shadow 0.4s ease !important;
        }

        .dark #theme-toggle {
            box-shadow: 0 0 15px 2px rgba(251, 191, 36, 0.3);
        }

        html:not(.dark) #theme-toggle {
            box-shadow: 0 0 15px 2px rgba(99, 102, 241, 0.3);
        }

        @keyframes themePulse {
            0% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(99, 102, 241, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
            }
        }

        #theme-toggle.pulse {
            animation: themePulse 0.6s ease-out;
        }

        .theme-flash {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 9999;
            opacity: 0;
        }

        .theme-flash.active {
            animation: flashFade 0.5s ease-out forwards;
        }

        .dark .theme-flash {
            background: radial-gradient(circle at center, rgba(251, 191, 36, 0.1) 0%, transparent 70%);
        }

        html:not(.dark) .theme-flash {
            background: radial-gradient(circle at center, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
        }

        @keyframes flashFade {
            0% {
                opacity: 0.8;
                transform: scale(0.8);
            }

            100% {
                opacity: 0;
                transform: scale(2);
            }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 400px;
            animation: toastSlideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            backdrop-filter: blur(10px);
        }

        .toast.toast-exit {
            animation: toastSlideOut 0.3s ease-in forwards;
        }

        @keyframes toastSlideIn {
            0% {
                transform: translateX(100%);
                opacity: 0;
            }

            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes toastSlideOut {
            0% {
                transform: translateX(0);
                opacity: 1;
            }

            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .toast-error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .toast-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .toast-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .toast-icon {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
        }

        .toast-message {
            font-size: 13px;
            opacity: 0.9;
        }

        .toast-close {
            flex-shrink: 0;
            padding: 4px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toast-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Row hover effect for tables */
        #destinations-tbody tr:hover,
        #stops-tbody tr:hover {
            background-color: rgba(99, 102, 241, 0.05);
        }

        .dark #destinations-tbody tr:hover,
        .dark #stops-tbody tr:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }
    </style>
</head>

<body class="min-h-screen bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-100 font-sans">
    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Purple Gradient Header (No Navigation) -->
    <header class="bg-gradient-to-r from-indigo-600 via-purple-600 to-blue-600 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="/" class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center backdrop-blur-sm">
                            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7">
                                </path>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-white">MobilityGraph</h1>
                            <p class="text-sm text-white/70">Jakarta Route Planner</p>
                        </div>
                    </a>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Dark/Light Mode Toggle -->
                    <button id="theme-toggle"
                        class="p-2 rounded-lg bg-white/20 hover:bg-white/30 text-white transition-colors"
                        title="Toggle theme">
                        <svg class="w-5 h-5 text-amber-300 hidden dark:block" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                                clip-rule="evenodd"></path>
                        </svg>
                        <svg class="w-5 h-5 block dark:hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                        </svg>
                    </button>
                    <!-- Logout Button -->
                    <form action="/admin/logout" method="POST" class="inline">
                        <button type="submit"
                            class="px-4 py-2 rounded-lg bg-white/20 hover:bg-white/30 text-white font-medium transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                                </path>
                            </svg>
                            Logout
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Halo Admin! üëã</h1>
                <p class="text-slate-600 dark:text-slate-400 mt-1">Data apa yang ingin kamu kelola hari ini?</p>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-12 h-12 rounded-xl bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center">
                            <svg class="w-6 h-6 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                                </path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-slate-900 dark:text-white" id="stat-destinations">12</p>
                            <p class="text-sm text-slate-600 dark:text-slate-400">Destinasi</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-mrt/10 flex items-center justify-center">
                            <!-- Train icon for MRT -->
                            <svg class="w-6 h-6 text-mrt" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M12 2C8 2 4 2.5 4 6v9.5C4 17.43 5.57 19 7.5 19L6 20.5v.5h2l2-2h4l2 2h2v-.5L16.5 19c1.93 0 3.5-1.57 3.5-3.5V6c0-3.5-4-4-8-4z" />
                            </svg>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-slate-900 dark:text-white" id="stat-mrt">13</p>
                            <p class="text-sm text-slate-600 dark:text-slate-400">Stasiun MRT</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-lrt/10 flex items-center justify-center">
                            <!-- Train icon for LRT -->
                            <svg class="w-6 h-6 text-lrt" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M12 2C8 2 4 2.5 4 6v9.5C4 17.43 5.57 19 7.5 19L6 20.5v.5h2l2-2h4l2 2h2v-.5L16.5 19c1.93 0 3.5-1.57 3.5-3.5V6c0-3.5-4-4-8-4z" />
                            </svg>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-slate-900 dark:text-white" id="stat-lrt">18</p>
                            <p class="text-sm text-slate-600 dark:text-slate-400">Stasiun LRT</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-tj/10 flex items-center justify-center">
                            <!-- Bus icon for TJ -->
                            <svg class="w-6 h-6 text-tj" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M4 16c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10z" />
                            </svg>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-slate-900 dark:text-white" id="stat-tj">252</p>
                            <p class="text-sm text-slate-600 dark:text-slate-400">Halte TJ</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Distribusi Moda Transportasi</h3>
                    <div class="relative h-64">
                        <canvas id="modeChart"></canvas>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Jumlah Pemberhentian per Moda</h3>
                    <div class="relative h-64">
                        <canvas id="stopsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div
                class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
                <!-- Tab Navigation -->
                <div class="border-b border-slate-200 dark:border-slate-700">
                    <nav class="flex gap-1 p-2">
                        <button class="tab-btn active px-4 py-2 rounded-lg font-medium transition-colors"
                            data-tab="destinations">
                            Destinasi
                        </button>
                        <button class="tab-btn px-4 py-2 rounded-lg font-medium transition-colors" data-tab="stops">
                            Halte/Stasiun
                        </button>
                        <button class="tab-btn px-4 py-2 rounded-lg font-medium transition-colors" data-tab="export">
                            Export TTL
                        </button>
                    </nav>
                </div>

                <!-- Tab Content: Destinations -->
                <div id="tab-destinations" class="tab-content p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-bold text-slate-900 dark:text-white">Kelola Destinasi</h2>
                        <button onclick="showAddDestinationModal()"
                            class="px-4 py-2 rounded-lg bg-gradient-to-r from-indigo-500 via-purple-500 to-blue-500 hover:from-indigo-600 hover:via-purple-600 hover:to-blue-600 text-white font-medium transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4">
                                </path>
                            </svg>
                            Tambah Destinasi
                        </button>
                    </div>

                    <div id="destinations-list"
                        class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
                        <table class="w-full text-left">
                            <thead class="bg-gradient-to-r from-indigo-600 via-purple-600 to-blue-600 text-white">
                                <tr>
                                    <th class="px-4 py-4 text-sm font-semibold">Gambar</th>
                                    <th class="px-4 py-4 text-sm font-semibold">Nama</th>
                                    <th class="px-4 py-4 text-sm font-semibold">Wilayah</th>
                                    <th class="px-4 py-4 text-sm font-semibold">Kategori</th>
                                    <th class="px-4 py-4 text-sm font-semibold">Deskripsi</th>
                                    <th class="px-4 py-4 text-sm font-semibold">Koordinat</th>
                                    <th class="px-4 py-4 text-sm font-semibold">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="destinations-tbody"
                                class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-slate-800">
                                <!-- Will be loaded dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab Content: Stops -->
                <div id="tab-stops" class="tab-content hidden p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-lg font-bold text-slate-900 dark:text-white">Kelola Halte/Stasiun</h2>
                            <p class="text-sm text-slate-600 dark:text-slate-400">Data dari sistem transportasi Jakarta
                            </p>
                        </div>
                        <div class="flex items-center gap-3">
                            <!-- Filter by mode -->
                            <select id="stops-mode-filter" onchange="filterStops()"
                                class="px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-sm">
                                <option value="">Semua Moda</option>
                                <option value="mrt">MRT</option>
                                <option value="lrt">LRT</option>
                                <option value="tj">TransJakarta</option>
                            </select>
                            <button onclick="showAddStopModal()"
                                class="px-4 py-2 rounded-lg bg-gradient-to-r from-indigo-500 via-purple-500 to-blue-500 hover:from-indigo-600 hover:via-purple-600 hover:to-blue-600 text-white font-medium transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4"></path>
                                </svg>
                                Tambah Halte/Stasiun
                            </button>
                        </div>
                    </div>

                    <div id="stops-list"
                        class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
                        <table class="w-full text-left">
                            <thead class="bg-gradient-to-r from-indigo-600 via-purple-600 to-blue-600 text-white">
                                <tr>
                                    <th class="px-4 py-4 text-sm font-semibold">ID</th>
                                    <th class="px-4 py-4 text-sm font-semibold">Nama</th>
                                    <th class="px-4 py-4 text-sm font-semibold">Mode</th>
                                    <th class="px-4 py-4 text-sm font-semibold">Koordinat</th>
                                    <th class="px-4 py-4 text-sm font-semibold">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="stops-tbody"
                                class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-slate-800">
                                <!-- Will be loaded dynamically -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div id="stops-pagination" class="flex items-center justify-between mt-4">
                        <p class="text-sm text-slate-600 dark:text-slate-400">
                            Menampilkan <span id="stops-showing">0</span> dari <span id="stops-total">0</span> data
                        </p>
                        <div class="flex items-center gap-2">
                            <button id="stops-prev-btn" onclick="loadStopsPrev()" disabled
                                class="px-3 py-1 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium text-sm disabled:opacity-50">
                                ‚Üê Prev
                            </button>
                            <button id="stops-next-btn" onclick="loadStopsNext()"
                                class="px-3 py-1 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium text-sm disabled:opacity-50">
                                Next ‚Üí
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Export -->
                <div id="tab-export" class="tab-content hidden p-6">
                    <div class="mb-6">
                        <h2 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Export Custom TTL</h2>
                        <p class="text-slate-600 dark:text-slate-400">Download file TTL yang berisi data custom yang
                            ditambahkan
                            melalui admin.</p>
                    </div>

                    <div class="flex gap-4 mb-6">
                        <button onclick="previewTTL()"
                            class="px-4 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 font-medium transition-colors">
                            Preview TTL
                        </button>
                        <button onclick="downloadTTL()"
                            class="px-4 py-2 rounded-lg bg-primary-500 hover:bg-primary-600 text-white font-medium transition-colors">
                            Download TTL
                        </button>
                    </div>

                    <div id="ttl-preview" class="hidden">
                        <pre
                            class="bg-slate-900 text-green-400 p-4 rounded-lg overflow-x-auto text-sm font-mono max-h-96 overflow-y-auto"></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Destination Modal -->
        <div id="destination-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
                <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
                    <h3 id="destination-modal-title" class="text-xl font-bold text-slate-900 dark:text-white">Tambah
                        Destinasi Baru</h3>
                    <button onclick="closeModal('destination-modal')"
                        class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12">
                            </path>
                        </svg>
                    </button>
                </div>
                <form id="destination-form" class="p-6 overflow-y-auto max-h-[70vh] space-y-4">
                    <input type="hidden" name="edit_mode" id="dest-edit-mode" value="">
                    <input type="hidden" name="original_slug" id="dest-original-slug" value="">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Nama</label>
                            <input type="text" name="name" required
                                class="w-full px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600">
                        </div>
                        <div>
                            <label
                                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Slug</label>
                            <input type="text" name="slug" required
                                class="w-full px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                                placeholder="contoh: nama-destinasi">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Wilayah</label>
                            <select name="region" required
                                class="w-full px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600">
                                <option value="mg:JakartaPusat">Jakarta Pusat</option>
                                <option value="mg:JakartaSelatan">Jakarta Selatan</option>
                                <option value="mg:JakartaTimur">Jakarta Timur</option>
                                <option value="mg:JakartaBarat">Jakarta Barat</option>
                                <option value="mg:JakartaUtara">Jakarta Utara</option>
                            </select>
                        </div>
                        <div>
                            <label
                                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Kategori</label>
                            <select name="category" required
                                class="w-full px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600">
                                <option value="Recreation">Recreation</option>
                                <option value="Historical">Historical</option>
                                <option value="Cultural">Cultural</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Sports">Sports</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Latitude</label>
                            <input type="number" step="any" name="lat" required
                                class="w-full px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600">
                        </div>
                        <div>
                            <label
                                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Longitude</label>
                            <input type="number" step="any" name="lon" required
                                class="w-full px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600">
                        </div>
                    </div>
                    <div>
                        <label
                            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Deskripsi</label>
                        <textarea name="description" rows="3"
                            class="w-full px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Gambar</label>
                        <!-- Toggle between URL and File Upload -->
                        <div class="flex gap-2 mb-3">
                            <button type="button" onclick="toggleImageInput('url')" id="btn-image-url"
                                class="px-3 py-1.5 text-sm font-medium rounded-lg bg-indigo-500 text-white transition-colors">
                                URL
                            </button>
                            <button type="button" onclick="toggleImageInput('file')" id="btn-image-file"
                                class="px-3 py-1.5 text-sm font-medium rounded-lg bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-slate-300 transition-colors">
                                Upload File
                            </button>
                        </div>
                        <!-- URL Input -->
                        <div id="image-url-input">
                            <input type="url" name="image_url" id="dest-image-url"
                                class="w-full px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600"
                                placeholder="https://example.com/image.jpg" oninput="updateImagePreview(this.value)">
                        </div>
                        <!-- File Upload Input -->
                        <div id="image-file-input" class="hidden">
                            <div class="flex items-center gap-3">
                                <label class="flex-1 cursor-pointer">
                                    <div
                                        class="flex items-center justify-center gap-2 px-4 py-3 rounded-lg border-2 border-dashed border-slate-300 dark:border-slate-600 hover:border-indigo-400 dark:hover:border-indigo-500 transition-colors bg-slate-50 dark:bg-slate-700/50">
                                        <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                        <span class="text-sm text-slate-500 dark:text-slate-400"
                                            id="file-upload-label">Klik untuk pilih gambar...</span>
                                    </div>
                                    <input type="file" id="dest-image-file" accept="image/*" class="hidden"
                                        onchange="handleImageFileSelect(this)">
                                </label>
                            </div>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">Format: JPG, PNG, GIF, WebP. Max:
                                5MB</p>
                        </div>
                        <!-- Image Preview -->
                        <div id="image-preview-container" class="mt-3 hidden">
                            <p class="text-xs text-slate-500 dark:text-slate-400 mb-2">Preview:</p>
                            <img id="image-preview" src="" alt="Preview"
                                class="max-w-full h-32 rounded-lg object-cover border border-slate-200 dark:border-slate-700"
                                onerror="document.getElementById('image-preview-container').classList.add('hidden')">
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" onclick="closeModal('destination-modal')"
                            class="px-4 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium">Batal</button>
                        <button type="submit"
                            class="px-4 py-2 rounded-lg bg-primary-500 hover:bg-primary-600 text-white font-medium">Simpan</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Stop Modal -->
        <div id="stop-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-md">
                <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
                    <h3 id="stop-modal-title" class="text-xl font-bold text-slate-900 dark:text-white">Tambah
                        Halte/Stasiun</h3>
                    <button onclick="closeModal('stop-modal')"
                        class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12">
                            </path>
                        </svg>
                    </button>
                </div>
                <form id="stop-form" class="p-6 space-y-4">
                    <input type="hidden" name="edit_mode" id="stop-edit-mode" value="">
                    <input type="hidden" name="original_id" id="stop-original-id" value="">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">ID</label>
                        <input type="text" name="stop_id" required
                            class="w-full px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Nama</label>
                        <input type="text" name="name" required
                            class="w-full px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Mode</label>
                        <select name="mode" required
                            class="w-full px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600">
                            <option value="TJ">TransJakarta</option>
                            <option value="MRT">MRT</option>
                            <option value="LRT">LRT</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Latitude</label>
                            <input type="number" step="any" name="lat" required
                                class="w-full px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600">
                        </div>
                        <div>
                            <label
                                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Longitude</label>
                            <input type="number" step="any" name="lon" required
                                class="w-full px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600">
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" onclick="closeModal('stop-modal')"
                            class="px-4 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium">Batal</button>
                        <button type="submit"
                            class="px-4 py-2 rounded-lg bg-primary-500 hover:bg-primary-600 text-white font-medium">Simpan</button>
                    </div>
                </form>
            </div>
        </div>

        <style>
            .tab-btn {
                color: #64748b;
            }

            .tab-btn:hover {
                background-color: #f1f5f9;
            }

            .dark .tab-btn:hover {
                background-color: #334155;
            }

            .tab-btn.active {
                background-color: #0ea5e9;
                color: white;
            }
        </style>

        <script>
            // Toast notification system
            function showToast(type, title, message, duration = 4000) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;

                const icons = {
                    success: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
                    error: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
                    info: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                    warning: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>'
                };

                toast.innerHTML = `
                    ${icons[type]}
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" onclick="closeToast(this.parentElement)">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;

                container.appendChild(toast);

                setTimeout(() => {
                    closeToast(toast);
                }, duration);
            }

            function closeToast(toast) {
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            }

            // Image preview for destination form
            function updateImagePreview(url) {
                const container = document.getElementById('image-preview-container');
                const preview = document.getElementById('image-preview');

                if (url && url.trim()) {
                    preview.src = url;
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                    preview.src = '';
                }
            }

            // Toggle between URL and File upload for images
            let currentImageInputType = 'url';
            let uploadedImageUrl = '';

            function toggleImageInput(type) {
                currentImageInputType = type;
                const urlInput = document.getElementById('image-url-input');
                const fileInput = document.getElementById('image-file-input');
                const btnUrl = document.getElementById('btn-image-url');
                const btnFile = document.getElementById('btn-image-file');

                if (type === 'url') {
                    urlInput.classList.remove('hidden');
                    fileInput.classList.add('hidden');
                    btnUrl.className = 'px-3 py-1.5 text-sm font-medium rounded-lg bg-indigo-500 text-white transition-colors';
                    btnFile.className = 'px-3 py-1.5 text-sm font-medium rounded-lg bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-slate-300 transition-colors';
                } else {
                    urlInput.classList.add('hidden');
                    fileInput.classList.remove('hidden');
                    btnFile.className = 'px-3 py-1.5 text-sm font-medium rounded-lg bg-indigo-500 text-white transition-colors';
                    btnUrl.className = 'px-3 py-1.5 text-sm font-medium rounded-lg bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-slate-300 transition-colors';
                }
            }

            // Handle file selection for image upload
            async function handleImageFileSelect(input) {
                const file = input.files[0];
                if (!file) return;

                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showToast('error', 'File Terlalu Besar', 'Ukuran file maksimal 5MB');
                    input.value = '';
                    return;
                }

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showToast('error', 'Format Tidak Valid', 'Hanya file gambar yang diperbolehkan');
                    input.value = '';
                    return;
                }

                // Update label
                document.getElementById('file-upload-label').textContent = file.name;

                // Show preview using FileReader
                const reader = new FileReader();
                reader.onload = function (e) {
                    updateImagePreview(e.target.result);
                };
                reader.readAsDataURL(file);

                // Upload file to server
                const formData = new FormData();
                formData.append('file', file);

                try {
                    showToast('info', 'Mengupload...', 'Gambar sedang diupload');
                    const response = await fetch('/admin/api/upload-image', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        uploadedImageUrl = result.url;
                        // Set the hidden URL field
                        document.getElementById('dest-image-url').value = uploadedImageUrl;
                        showToast('success', 'Berhasil', 'Gambar berhasil diupload');
                    } else {
                        const error = await response.json();
                        showToast('error', 'Gagal Upload', error.detail || 'Gagal mengupload gambar');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    showToast('error', 'Error', 'Terjadi kesalahan saat mengupload');
                }
            }

            // Stops data management
            let allStopsData = [];
            let stopsPage = 0;
            const stopsPerPage = 20;
            let stopsFilter = '';

            // Tab switching with data loading
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    btn.classList.add('active');
                    const tabName = btn.dataset.tab;
                    document.getElementById('tab-' + tabName).classList.remove('hidden');

                    // Load data when switching to stops tab
                    if (tabName === 'stops' && allStopsData.length === 0) {
                        loadStopsData();
                    }
                });
            });

            // Load destinations
            async function loadDestinations() {
                try {
                    const response = await fetch('/api/destinations');
                    const destinations = await response.json();

                    const tbody = document.getElementById('destinations-tbody');
                    tbody.innerHTML = destinations.map(dest => `
                <tr class="transition-colors hover:bg-slate-50 dark:hover:bg-slate-700/50">
                    <td class="px-4 py-3">
                        <img src="${dest.image_url || 'https://via.placeholder.com/60x60?text=No+Image'}" 
                             alt="${dest.name}" 
                             class="w-12 h-12 rounded-lg object-cover border border-slate-200 dark:border-slate-700"
                             onerror="this.src='https://via.placeholder.com/60x60?text=No+Image'">
                    </td>
                    <td class="px-4 py-3 text-slate-900 dark:text-white font-medium">${dest.name}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300">${dest.region}</span>
                    </td>
                    <td class="px-4 py-3 text-slate-600 dark:text-slate-400">${dest.category || '-'}</td>
                    <td class="px-4 py-3 text-slate-600 dark:text-slate-400 text-sm max-w-xs truncate" title="${(dest.description || dest.long_description || '-').replace(/"/g, '&quot;')}">${(dest.description || dest.long_description || '-').substring(0, 50)}${(dest.description || dest.long_description || '').length > 50 ? '...' : ''}</td>
                    <td class="px-4 py-3 text-slate-600 dark:text-slate-400 text-sm">${dest.lat?.toFixed(4)}, ${dest.lon?.toFixed(4)}</td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-2">
                            <button onclick="editDestination('${dest.slug}')" class="px-3 py-1.5 rounded-lg bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 hover:bg-primary-200 dark:hover:bg-primary-900/50 text-sm font-medium flex items-center gap-1 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                Edit
                            </button>
                            <button onclick="deleteDestination('${dest.slug}')" class="px-3 py-1.5 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50 text-sm font-medium flex items-center gap-1 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Hapus
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

                    document.getElementById('stat-destinations').textContent = destinations.length;
                } catch (error) {
                    console.error('Error loading destinations:', error);
                }
            }

            // Load custom stops
            async function loadCustomStops() {
                try {
                    const response = await fetch('/admin/api/custom-stops');
                    const stops = await response.json();

                    const tbody = document.getElementById('stops-tbody');
                    if (stops.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-slate-500 dark:text-slate-400">Belum ada halte/stasiun custom</td></tr>';
                    } else {
                        tbody.innerHTML = stops.map(stop => `
                    <tr>
                        <td class="px-4 py-3 text-slate-600 dark:text-slate-400 font-mono text-sm">${stop.id}</td>
                        <td class="px-4 py-3 text-slate-900 dark:text-white font-medium">${stop.name}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs font-bold mode-${stop.mode?.toLowerCase()} text-white">${stop.mode}</span></td>
                        <td class="px-4 py-3 text-slate-600 dark:text-slate-400">${stop.lat?.toFixed(4)}, ${stop.lon?.toFixed(4)}</td>
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <button onclick="editStop('${stop.id}')" class="px-3 py-1.5 rounded-lg bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 hover:bg-primary-200 dark:hover:bg-primary-900/50 text-sm font-medium flex items-center gap-1 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                    Edit
                                </button>
                                <button onclick="deleteStop('${stop.id}')" class="px-3 py-1.5 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50 text-sm font-medium flex items-center gap-1 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                    Hapus
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                    }
                } catch (error) {
                    console.error('Error loading stops:', error);
                }
            }

            // Load ALL stops from API (for the table)
            async function loadStopsData() {
                try {
                    const response = await fetch('/api/stops?limit=1000');
                    const data = await response.json();
                    allStopsData = data.stops || [];
                    stopsPage = 0;
                    renderStops();
                    showToast('success', 'Data Berhasil Dimuat', `${allStopsData.length} halte/stasiun berhasil dimuat`);
                } catch (error) {
                    console.error('Error loading stops:', error);
                    showToast('error', 'Gagal Memuat Data', 'Tidak dapat memuat data halte/stasiun');
                }
            }

            // Filter stops by mode
            function filterStops() {
                stopsFilter = document.getElementById('stops-mode-filter').value;
                stopsPage = 0;
                renderStops();
            }

            // Render stops table with pagination
            function renderStops() {
                let filteredStops = allStopsData;
                if (stopsFilter) {
                    filteredStops = allStopsData.filter(s => s.mode?.toLowerCase() === stopsFilter);
                }

                const start = stopsPage * stopsPerPage;
                const end = start + stopsPerPage;
                const pageStops = filteredStops.slice(start, end);

                const tbody = document.getElementById('stops-tbody');
                if (pageStops.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-slate-500 dark:text-slate-400">Tidak ada data</td></tr>';
                } else {
                    tbody.innerHTML = pageStops.map(stop => `
                        <tr class="transition-colors hover:bg-slate-50 dark:hover:bg-slate-700/50">
                            <td class="px-4 py-3 text-slate-600 dark:text-slate-400 font-mono text-sm">${stop.id || stop.stop_id || '-'}</td>
                            <td class="px-4 py-3 text-slate-900 dark:text-white font-medium">${stop.name}</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 rounded text-xs font-bold mode-${stop.mode?.toLowerCase()} text-white">${stop.mode || '-'}</span>
                            </td>
                            <td class="px-4 py-3 text-slate-600 dark:text-slate-400">${stop.lat?.toFixed(4) || '-'}, ${stop.lon?.toFixed(4) || '-'}</td>
                            <td class="px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <button onclick="editStopData('${stop.id || stop.stop_id}')" class="px-3 py-1.5 rounded-lg bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 hover:bg-primary-200 dark:hover:bg-primary-900/50 text-sm font-medium flex items-center gap-1 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                        Edit
                                    </button>
                                    <button onclick="deleteStopData('${stop.id || stop.stop_id}')" class="px-3 py-1.5 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50 text-sm font-medium flex items-center gap-1 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                        Hapus
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }

                // Update pagination info
                document.getElementById('stops-showing').textContent = `${start + 1}-${Math.min(end, filteredStops.length)}`;
                document.getElementById('stops-total').textContent = filteredStops.length;

                // Update button states
                document.getElementById('stops-prev-btn').disabled = stopsPage === 0;
                document.getElementById('stops-next-btn').disabled = end >= filteredStops.length;
            }

            function loadStopsPrev() {
                if (stopsPage > 0) {
                    stopsPage--;
                    renderStops();
                }
            }

            function loadStopsNext() {
                const filteredStops = stopsFilter
                    ? allStopsData.filter(s => s.mode?.toLowerCase() === stopsFilter)
                    : allStopsData;
                if ((stopsPage + 1) * stopsPerPage < filteredStops.length) {
                    stopsPage++;
                    renderStops();
                }
            }

            function viewStop(stopId) {
                showToast('info', 'Info Halte', `Detail halte ${stopId} akan ditampilkan`);
            }

            // Edit stop data function - uses local data from allStopsData
            function editStopData(stopId) {
                // Find the stop in allStopsData
                const stop = allStopsData.find(s => (s.id || s.stop_id) === stopId);

                if (!stop) {
                    showToast('error', 'Tidak Ditemukan', 'Data halte/stasiun tidak ditemukan');
                    return;
                }

                // Switch modal to edit mode
                document.getElementById('stop-modal-title').textContent = 'Edit Halte/Stasiun';
                document.getElementById('stop-edit-mode').value = 'true';
                document.getElementById('stop-original-id').value = stopId;

                // Fill form with existing data
                const form = document.getElementById('stop-form');
                form.querySelector('input[name="stop_id"]').value = stop.id || stop.stop_id || stopId;
                form.querySelector('input[name="stop_id"]').disabled = true; // Disable ID field for edit
                form.querySelector('input[name="name"]').value = stop.name || '';
                form.querySelector('select[name="mode"]').value = stop.mode || 'TJ';
                form.querySelector('input[name="lat"]').value = stop.lat || '';
                form.querySelector('input[name="lon"]').value = stop.lon || stop.long || '';

                // Show modal
                document.getElementById('stop-modal').classList.remove('hidden');
                showToast('info', 'Mode Edit', `Mengubah halte/stasiun: ${stop.name || stopId}`);
            }

            // Delete stop data with confirm dialog
            async function deleteStopData(stopId) {
                // Show custom confirm dialog
                const confirmed = confirm(`Yakin ingin menghapus halte/stasiun dengan ID: ${stopId}?`);
                if (!confirmed) return;

                try {
                    const response = await fetch(`/admin/api/stop/${encodeURIComponent(stopId)}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        showToast('success', 'Berhasil Dihapus', `Halte ${stopId} telah dihapus`);
                        // Reload the stops data
                        loadStopsData();
                    } else {
                        showToast('error', 'Gagal Menghapus', 'Tidak dapat menghapus halte/stasiun');
                    }
                } catch (error) {
                    console.error('Error deleting stop:', error);
                    showToast('error', 'Error', 'Terjadi kesalahan saat menghapus');
                }
            }

            // Modal functions
            function showAddDestinationModal() {
                // Reset to add mode
                document.getElementById('destination-modal-title').textContent = 'Tambah Destinasi Baru';
                document.getElementById('dest-edit-mode').value = '';
                document.getElementById('dest-original-slug').value = '';
                document.getElementById('destination-form').reset();
                document.getElementById('destination-modal').classList.remove('hidden');
            }

            function showAddStopModal() {
                // Reset to add mode
                document.getElementById('stop-modal-title').textContent = 'Tambah Halte/Stasiun Baru';
                document.getElementById('stop-edit-mode').value = '';
                document.getElementById('stop-original-id').value = '';
                document.getElementById('stop-form').reset();
                // Enable ID field for add mode
                document.querySelector('#stop-form input[name="stop_id"]').disabled = false;
                document.getElementById('stop-modal').classList.remove('hidden');
            }

            function closeModal(id) {
                document.getElementById(id).classList.add('hidden');
                // Reset forms on close
                if (id === 'destination-modal') {
                    document.getElementById('destination-form').reset();
                    document.getElementById('dest-edit-mode').value = '';
                } else if (id === 'stop-modal') {
                    document.getElementById('stop-form').reset();
                    document.getElementById('stop-edit-mode').value = '';
                    document.querySelector('#stop-form input[name="stop_id"]').disabled = false;
                }
            }

            // Form submissions
            document.getElementById('destination-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                const data = Object.fromEntries(formData);
                const isEdit = data.edit_mode === 'true';
                const originalSlug = data.original_slug;

                // Remove hidden fields from payload
                delete data.edit_mode;
                delete data.original_slug;

                try {
                    let response;
                    if (isEdit) {
                        // Update existing destination
                        response = await fetch(`/admin/api/destination/${originalSlug}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                    } else {
                        // Create new destination
                        response = await fetch('/admin/api/destination', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                    }

                    if (response.ok) {
                        closeModal('destination-modal');
                        loadDestinations();
                        this.reset();
                        showToast('success', isEdit ? 'Berhasil Diperbarui' : 'Berhasil Ditambahkan',
                            isEdit ? 'Destinasi berhasil diperbarui' : 'Destinasi baru berhasil ditambahkan');
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        showToast('error', 'Gagal Menyimpan', errorData.detail || 'Gagal menyimpan destinasi');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showToast('error', 'Error', 'Terjadi kesalahan saat menyimpan');
                }
            });

            document.getElementById('stop-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                const data = Object.fromEntries(formData);
                const isEdit = data.edit_mode === 'true';
                const originalId = data.original_id;

                // Remove hidden fields from payload
                delete data.edit_mode;
                delete data.original_id;

                try {
                    let response;
                    if (isEdit) {
                        // Update existing stop
                        response = await fetch(`/admin/api/stop/${encodeURIComponent(originalId)}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                    } else {
                        // Create new stop
                        response = await fetch('/admin/api/stop', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                    }

                    if (response.ok) {
                        closeModal('stop-modal');
                        loadCustomStops();
                        loadStopsData(); // Reload all stops
                        this.reset();
                        showToast('success', isEdit ? 'Berhasil Diperbarui' : 'Berhasil Ditambahkan',
                            isEdit ? 'Halte/Stasiun berhasil diperbarui' : 'Halte/Stasiun baru berhasil ditambahkan');
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        showToast('error', 'Gagal Menyimpan', errorData.detail || 'Gagal menyimpan halte/stasiun');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showToast('error', 'Error', 'Terjadi kesalahan saat menyimpan');
                }
            });

            // Delete functions
            async function deleteDestination(slug) {
                if (!confirm('Yakin ingin menghapus destinasi ini?')) return;

                try {
                    const response = await fetch(`/admin/api/destination/${slug}`, { method: 'DELETE' });
                    if (response.ok) {
                        loadDestinations();
                        showToast('success', 'Berhasil Dihapus', 'Destinasi berhasil dihapus');
                    } else {
                        showToast('error', 'Gagal Menghapus', 'Tidak dapat menghapus destinasi');
                    }
                } catch (error) {
                    showToast('error', 'Error', 'Terjadi kesalahan saat menghapus');
                }
            }

            async function deleteStop(id) {
                if (!confirm('Yakin ingin menghapus halte/stasiun ini?')) return;

                try {
                    const response = await fetch(`/admin/api/stop/${encodeURIComponent(id)}`, { method: 'DELETE' });
                    if (response.ok) {
                        loadCustomStops();
                        showToast('success', 'Berhasil Dihapus', 'Halte/Stasiun berhasil dihapus');
                    } else {
                        showToast('error', 'Gagal Menghapus', 'Tidak dapat menghapus halte/stasiun');
                    }
                } catch (error) {
                    showToast('error', 'Error', 'Terjadi kesalahan saat menghapus');
                }
            }

            // TTL preview/download
            async function previewTTL() {
                try {
                    const response = await fetch('/admin/api/export-ttl');
                    const ttl = await response.text();
                    document.querySelector('#ttl-preview pre').textContent = ttl;
                    document.getElementById('ttl-preview').classList.remove('hidden');
                    showToast('success', 'Preview Dimuat', 'File TTL berhasil dimuat');
                } catch (error) {
                    showToast('error', 'Gagal Memuat', 'Tidak dapat memuat file TTL');
                }
            }

            function downloadTTL() {
                window.location.href = '/admin/api/export-ttl?download=1';
                showToast('info', 'Download', 'File TTL sedang didownload');
            }

            // Load stats
            async function loadStats() {
                try {
                    const response = await fetch('/api/summary');
                    const data = await response.json();
                    if (data.mrt_count) document.getElementById('stat-mrt').textContent = data.mrt_count;
                    if (data.lrt_count) document.getElementById('stat-lrt').textContent = data.lrt_count;
                    if (data.tj_count) document.getElementById('stat-tj').textContent = data.tj_count;
                } catch (error) {
                    console.log('Could not fetch stats');
                }
            }

            // Initialize
            loadDestinations();
            loadCustomStops();
            loadStats();

            // Placeholder edit functions
            async function editDestination(slug) {
                try {
                    // First, fetch ALL destinations from the general API
                    const allDestResponse = await fetch('/api/destinations');
                    const allDestinations = await allDestResponse.json();

                    // Find the destination by slug
                    const dest = allDestinations.find(d => d.slug === slug);

                    if (!dest) {
                        showToast('error', 'Tidak Ditemukan', 'Destinasi tidak ditemukan');
                        return;
                    }

                    // Switch modal to edit mode
                    document.getElementById('destination-modal-title').textContent = 'Edit Destinasi';
                    document.getElementById('dest-edit-mode').value = 'true';
                    document.getElementById('dest-original-slug').value = slug;

                    // Fill form with existing data
                    const form = document.getElementById('destination-form');
                    form.querySelector('input[name="name"]').value = dest.name || '';
                    form.querySelector('input[name="slug"]').value = dest.slug || slug;

                    // Handle region value (may need to add 'mg:' prefix)
                    let regionValue = dest.region || 'mg:JakartaPusat';
                    if (!regionValue.startsWith('mg:')) {
                        regionValue = 'mg:' + regionValue.replace(/\s+/g, '');
                    }
                    form.querySelector('select[name="region"]').value = regionValue;

                    form.querySelector('select[name="category"]').value = dest.category || 'Recreation';
                    form.querySelector('input[name="lat"]').value = dest.lat || '';
                    form.querySelector('input[name="lon"]').value = dest.lon || '';
                    form.querySelector('textarea[name="description"]').value = dest.description || '';

                    // Handle image URL and preview
                    const imageUrl = dest.image_url || '';
                    const imageInput = form.querySelector('input[name="image_url"]');
                    if (imageInput) {
                        imageInput.value = imageUrl;
                        updateImagePreview(imageUrl);
                    }

                    // Show modal
                    document.getElementById('destination-modal').classList.remove('hidden');
                    showToast('info', 'Mode Edit', 'Mengubah destinasi: ' + dest.name);
                } catch (error) {
                    console.error('Error fetching destination:', error);
                    showToast('error', 'Error', 'Gagal memuat data destinasi');
                }
            }

            async function editStop(id) {
                try {
                    // Fetch stop data from API
                    const response = await fetch(`/admin/api/stop/${encodeURIComponent(id)}`);
                    if (!response.ok) {
                        // If not found in custom stops, it might be from TTL (not editable via this method)
                        showToast('warning', 'Tidak Dapat Diedit', 'Halte/Stasiun bawaan tidak dapat diedit. Hanya halte/stasiun yang ditambahkan melalui admin yang dapat diedit.');
                        return;
                    }

                    const stop = await response.json();

                    // Switch modal to edit mode
                    document.getElementById('stop-modal-title').textContent = 'Edit Halte/Stasiun';
                    document.getElementById('stop-edit-mode').value = 'true';
                    document.getElementById('stop-original-id').value = id;

                    // Fill form with existing data
                    const form = document.getElementById('stop-form');
                    form.querySelector('input[name="stop_id"]').value = stop.id || id;
                    form.querySelector('input[name="stop_id"]').disabled = true; // Disable ID field for edit
                    form.querySelector('input[name="name"]').value = stop.name || '';
                    form.querySelector('select[name="mode"]').value = stop.mode || 'TJ';
                    form.querySelector('input[name="lat"]').value = stop.lat || '';
                    form.querySelector('input[name="lon"]').value = stop.lon || '';

                    // Show modal
                    document.getElementById('stop-modal').classList.remove('hidden');
                } catch (error) {
                    console.error('Error fetching stop:', error);
                    showToast('error', 'Error', 'Gagal memuat data halte/stasiun');
                }
            }
        </script>

        <!-- Chart.js CDN -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            // Initialize charts after page load
            document.addEventListener('DOMContentLoaded', async function () {
                try {
                    const response = await fetch('/api/summary');
                    const data = await response.json();

                    const mrtCount = data.mrt_count || 13;
                    const lrtCount = data.lrt_count || 18;
                    const tjCount = data.tj_count || 252;

                    // Pie Chart - Mode Distribution
                    const modeCtx = document.getElementById('modeChart').getContext('2d');
                    new Chart(modeCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['MRT', 'LRT', 'TransJakarta'],
                            datasets: [{
                                data: [mrtCount, lrtCount, tjCount],
                                backgroundColor: ['#e63946', '#f4a261', '#2a9d8f'],
                                borderWidth: 0,
                                hoverOffset: 10
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 20,
                                        usePointStyle: true
                                    }
                                }
                            }
                        }
                    });

                    // Bar Chart - Stops per Mode
                    const stopsCtx = document.getElementById('stopsChart').getContext('2d');
                    new Chart(stopsCtx, {
                        type: 'bar',
                        data: {
                            labels: ['MRT', 'LRT', 'TransJakarta'],
                            datasets: [{
                                label: 'Jumlah Pemberhentian',
                                data: [mrtCount, lrtCount, tjCount],
                                backgroundColor: ['#e63946', '#f4a261', '#2a9d8f'],
                                borderRadius: 8,
                                borderSkipped: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        display: true,
                                        color: 'rgba(0,0,0,0.05)'
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error loading charts:', error);
                }
            });
        </script>

        <!-- Theme Toggle Script -->
        <script>
            const themeToggle = document.getElementById('theme-toggle');
            const html = document.documentElement;

            // Create flash element for theme transition effect
            const themeFlash = document.createElement('div');
            themeFlash.className = 'theme-flash';
            document.body.appendChild(themeFlash);

            function getThemePreference() {
                if (localStorage.getItem('theme')) return localStorage.getItem('theme');
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            function applyTheme(theme, animate = false) {
                if (animate) {
                    html.classList.add('theme-transition');
                    themeFlash.classList.add('active');
                    themeToggle.classList.add('pulse');

                    setTimeout(() => {
                        html.classList.remove('theme-transition');
                        themeFlash.classList.remove('active');
                        themeToggle.classList.remove('pulse');
                    }, 600);
                }

                if (theme === 'dark') {
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                }
                localStorage.setItem('theme', theme);
            }

            applyTheme(getThemePreference(), false);

            themeToggle.addEventListener('click', () => {
                const currentTheme = html.classList.contains('dark') ? 'dark' : 'light';
                applyTheme(currentTheme === 'dark' ? 'light' : 'dark', true);
            });
        </script>
    </main>
</body>

</html>